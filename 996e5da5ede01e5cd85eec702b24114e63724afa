{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "b43bd7ea_bd509d9b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-10-01T01:05:15Z",
      "side": 1,
      "message": "Let me add more owners.\n\nWhile there doesn\u0027t seem to be anything technically wrong here, this IMHO looks like a discrimination. Why should we give such a privilege (i.e. providing system storage) to gmscore? That storage wouldn\u0027t be accounted for gmscore.",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "06748612_288f2e0a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1208973
      },
      "writtenOn": "2021-10-01T01:24:24Z",
      "side": 1,
      "message": "Agreed.  I see the linked bug addresses this somewhat, but I don\u0027t have the context to understand it fully.  Could you explain why GMSCore needs this?",
      "parentUuid": "b43bd7ea_bd509d9b",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "086d23a5_46aa32ae",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1088085
      },
      "writtenOn": "2021-10-01T02:05:58Z",
      "side": 1,
      "message": "Actually the storage isn\u0027t exclusive to GMScore. The directory then can be used by other custom checkin apps as well, e.g. the checkin app of android things. And if other checkin apps want to use the space, they can add custom permissions here too. So I feel it\u0027s better to create a new dir than reusing the /data/ota dirs.  \n\nIn short, the device needs to store a pair of id:token to perform checkin. And for GMScore devices, we store the primary copy inside GMScore. However, we need somewhere else to backup the data if users clear the GMScore data. (As a technical detail, old Pixels wrongly use another app\u0027s storage as a backup place.)\n\nbtw, the token is merely a string of integers \u003c 128 bytes. And checkin is a server service that anyone can use, it doesn\u0027t necessarily ties to gmscore.",
      "parentUuid": "06748612_288f2e0a",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c3102564_99995384",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-10-01T04:03:13Z",
      "side": 1,
      "message": "Thanks for the explanation. I have a feeling that such a need should be fulfilled by a system service. Can the backup service be a solution?",
      "parentUuid": "086d23a5_46aa32ae",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "92714dfa_ee1dfe64",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1088085
      },
      "writtenOn": "2021-10-01T04:11:07Z",
      "side": 1,
      "message": "Thanks for the suggestion. We want some place local on the device \u0026\u0026 have read protections. Where can I read more on the backup service?",
      "parentUuid": "c3102564_99995384",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7ac0d46c_6fde8293",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1088085
      },
      "writtenOn": "2021-10-01T04:22:00Z",
      "side": 1,
      "message": "hmm, seems the Android Backup Service isn\u0027t very suitable. As the use case is to backup a specific string, instead of the entire app data...",
      "parentUuid": "92714dfa_ee1dfe64",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ef9f1e4c_8e8432a8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-10-05T14:52:34Z",
      "side": 1,
      "message": "I don\u0027t know much about backup service, but the document [1] says that there are two options: key/value backup and auto backup. The former seems to be what you are looking for. The latter is for the entire app data, but it looks like it can be configured to filter only the needed file.\n\nI am not insisting that you must use backup service though. I just thought that such a use of system storage should be through a system service - be it the backup service, the settings provider, or whatever. \n\n[1] https://developer.android.com/guide/topics/data/backup#Choosing",
      "parentUuid": "7ac0d46c_6fde8293",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d6eedba4_dd4d5f25",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1054468
      },
      "writtenOn": "2021-10-05T16:47:20Z",
      "side": 1,
      "message": "I somehow missed this thread. However, I think I generally agree with Jiyong\u0027s point that this seems like it should be a system service. That would allow you to address my concerns about multi-user separation.\n\nAnd side note, /data/ota also seems to be a problem wrt multi-user separation, and just fortunately doesn\u0027t have the problem because OTAs are not particularly user-specific.",
      "parentUuid": "ef9f1e4c_8e8432a8",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1cb9ad51_a60c4da2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1088085
      },
      "writtenOn": "2021-10-05T18:07:31Z",
      "side": 1,
      "message": "hmm, you guys are right as the multi-user separation is indeed a concern for this usecase.\n\nI looked at the backup service closely and both options will do the backup once every few hours; while I prefer an instant local I/O... And I have\u0027t figured out if it\u0027s possible to restrict read access to settings provider.. Exploring other options.",
      "parentUuid": "d6eedba4_dd4d5f25",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7ae8fa99_9af3cb96",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1088085
      },
      "writtenOn": "2021-10-05T22:37:27Z",
      "side": 1,
      "message": "Here\u0027s a summary in https://yaqs.corp.google.com/eng/q/1567688076929531904. It seems none of the solution is perfect... \n\nIs it acceptable to put all users\u0027 token in /data/checkin and only give checkin app the access?",
      "parentUuid": "1cb9ad51_a60c4da2",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "22a753a9_bc22cb90",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-10-06T02:42:46Z",
      "side": 1,
      "message": "I learned that restore happens only when an app is newly installed. Then using the backup service doesn\u0027t look feasible. I am leaning toward using /data as we don\u0027t seem to have any better option.\n\nI still don\u0027t fully understand the reason why the android_id:token shouldn\u0027t be deleted even when user explicitly deleted the app storage. Where do the id and the token come from initially? Why is it okay to delete them via factory reset, but not via app storage delete?",
      "parentUuid": "7ae8fa99_9af3cb96",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a5a5f39a_c18dde1b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1088085
      },
      "writtenOn": "2021-10-06T02:50:50Z",
      "side": 1,
      "message": "In fact, is it better to use the \"/data/misc_ce/user_id/checkin\". Seems none of the app space / system service solution meet our need here...\n\n\u003e Why is it okay to delete them via factory reset, but not via app storage delete?\nMore context in http://b/26468436#comment15. The aid:token pair is critical to the checkin service. And the aid is already exposed a gservice flag + setting.secure; so it persists after gmscore wipe, but not factory reset. We very much want the same lifespan for the token file.   \n\nI believe that pair is initially created at checkin time right after factory reset. And if the device lost the token, it cannot checkin until another factory reset.",
      "parentUuid": "7ae8fa99_9af3cb96",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d93ebad1_0f59d418",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1054468
      },
      "writtenOn": "2021-10-06T07:52:28Z",
      "side": 1,
      "message": "\u003e In fact, is it better to use the \"/data/misc_ce/user_id/checkin\". Seems none of the app space / system service solution meet our need here...\n\nThis is definitely much better, and completely resolves the multi-user issues. However, now we have an arbitrary data dir which gmscore (and eventually other apps?) can write anything to to bypass an app data wipe. I still think we need some kind of service to manage this data so that it\u0027s well scoped and not arbitrary. A checkin service? Can BlobStoreManager be used for this? https://developer.android.com/reference/android/app/blob/BlobStoreManager",
      "parentUuid": "a5a5f39a_c18dde1b",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "effb508c_c93ac2a1",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1088085
      },
      "writtenOn": "2021-10-06T17:52:51Z",
      "side": 1,
      "message": "Yeah it\u0027s unfortunate that none of the app space solution work well for us. I am checking with the author of BlobStoreManager. After preliminary read, I found the app at least need to store tuple of (algorithm, digest, label, expiryTimeMillis, tag) to identify/access the blob...That seems to transfer the problem to a different one, as the token itself should be small\n\nOn the other hand, the checkin apps should be either system apps or system services, so the usage should be generally trustworth. And gmscore already have access to some places in the /data dir, it\u0027s much cleaner to have a dedicated dir for this special purpose.",
      "parentUuid": "d93ebad1_0f59d418",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b5129eaf_43ad2caf",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1088085
      },
      "writtenOn": "2021-10-06T18:21:16Z",
      "side": 1,
      "message": "Update: Sudheer told me the digest is the key to access the blob. So whatever mechanism it is using to get the hash can be used to get the actual data itself :(",
      "parentUuid": "effb508c_c93ac2a1",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4c9794c5_2dcf4966",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-10-07T05:55:00Z",
      "side": 1,
      "message": "It looks like you can lease the blob using acquireLease, and then query the list of blob handles that are from the calling app using getLeasedBlobs. You could then use the blob handle (which will be one in your case) to open a session and read the data.",
      "parentUuid": "b5129eaf_43ad2caf",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2de7333f_f9dc82ab",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1088085
      },
      "writtenOn": "2021-10-07T06:17:35Z",
      "side": 1,
      "message": "Adding Sudheer to the change. Hey Sudheer, do you know if getLeasedBlobs can obtain the app\u0027s previously saved blob (in case of app data wipe and the digest is unknown)",
      "parentUuid": "4c9794c5_2dcf4966",
      "revId": "996e5da5ede01e5cd85eec702b24114e63724afa",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}