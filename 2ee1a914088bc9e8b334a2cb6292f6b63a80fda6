{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "054d741a_8f8e27c7",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1954223
      },
      "writtenOn": "2022-09-22T07:34:15Z",
      "side": 1,
      "message": "Here we go! The changes requested by alanstokes@ pushed to aosp",
      "revId": "2ee1a914088bc9e8b334a2cb6292f6b63a80fda6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b8eab8d9_21ce2f89",
        "filename": "private/dumpstate.te",
        "patchSetId": 1
      },
      "lineNbr": 27,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2022-09-22T11:27:00Z",
      "side": 1,
      "message": "You shouldn\u0027t need these changes - dumpstate should keep its current permissions, and layertracegenerator gets the extra permission below, following the principle of least privilege.",
      "range": {
        "startLine": 26,
        "startChar": 0,
        "endLine": 27,
        "endChar": 56
      },
      "revId": "2ee1a914088bc9e8b334a2cb6292f6b63a80fda6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6a96bae7_dc8002c5",
        "filename": "private/dumpstate.te",
        "patchSetId": 1
      },
      "lineNbr": 28,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2022-09-22T11:27:00Z",
      "side": 1,
      "message": "This allows dumpstate to execute layertracegenerator_exec in the dumpstate domain.\nBut that\u0027s not what you want, I believe - you want it to run in the new layertracegenerator domain defined below.\n\nSo instead of this, you want:\ndomain_auto_trans(dumpstate, layertracegenerator_exec, layertracegenerator)\n\nWhich does everything you need. (See http://cs/android/system/sepolicy/public/te_macros?rcl\u003db5cf7354e8f700205290d203986b0de544077a78\u0026l\u003d24)",
      "range": {
        "startLine": 28,
        "startChar": 1,
        "endLine": 28,
        "endChar": 62
      },
      "revId": "2ee1a914088bc9e8b334a2cb6292f6b63a80fda6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5e8c6e3a_fb920533",
        "filename": "private/dumpstate.te",
        "patchSetId": 1
      },
      "lineNbr": 28,
      "author": {
        "id": 1954223
      },
      "writtenOn": "2022-09-23T07:47:37Z",
      "side": 1,
      "message": "Thank you a lot for the explanation Alan üôè now things make more sense to me\n\nI\u0027d like to sanity check something\n\nNow dumpstate is executing layertracegenerator like this:\n`/system/xbin/su system /system/bin/layertracegenerator \u003cparams...\u003e`\n\n\nI added the switch to system\u0027s UID, otherwise layertracegenerator can\u0027t write to /data/misc/wmtrace:\n```\noriole:/ # ls -l /data/misc |grep wmtrace                                                                                                  \ndrwxrwxr-x  2 system       system       3452 2022-09-23 09:15 wmtrace\n```\n\nHowever, I see now that going through /system/xbin/su involves a `domain_auto_trans(dumpstate, su_exec, su)`:\nhttps://source.corp.google.com/android/system/sepolicy/private/su.te;rcl\u003d90f9c60d4b8a79c0d9eb29a86d29144ce81fa786;l\u003d7\n\nso does the `domain_auto_trans(dumpstate, layertracegenerator_exec, layertracegenerator)` still makes sense?\n\nI am wondering because afaiu when the exec(\"/system/bin/layertracegenerator\", ...) happens, we\u0027ll be in the `su` domain and no longer in `dumpstate`. No?",
      "parentUuid": "6a96bae7_dc8002c5",
      "range": {
        "startLine": 28,
        "startChar": 1,
        "endLine": 28,
        "endChar": 62
      },
      "revId": "2ee1a914088bc9e8b334a2cb6292f6b63a80fda6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2d161340_e5b6fb1e",
        "filename": "private/dumpstate.te",
        "patchSetId": 1
      },
      "lineNbr": 28,
      "author": {
        "id": 1954223
      },
      "writtenOn": "2022-09-23T09:35:19Z",
      "side": 1,
      "message": "Oh interesting...\n\nlooks like since I introduced `/system/xbin/su system`, SELinux doesn\u0027t deny the execution of layertracegenerator anymore\n\nI just tried to remove all my SELinux changes and dumpstate can successfully execute layertracegenerator.\n\nI assume that with `/system/xbin/su system` there is a transition into `su` domain where everything is allowed (?)",
      "parentUuid": "5e8c6e3a_fb920533",
      "range": {
        "startLine": 28,
        "startChar": 1,
        "endLine": 28,
        "endChar": 62
      },
      "revId": "2ee1a914088bc9e8b334a2cb6292f6b63a80fda6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5ea521ad_6622afd5",
        "filename": "private/dumpstate.te",
        "patchSetId": 1
      },
      "lineNbr": 28,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2022-09-23T09:47:15Z",
      "side": 1,
      "message": "Yes, su is permissive, so no selinux rules are applied to it - but only in userdebug_or_eng, of course. http://cs/android/system/sepolicy/private/su.te?rcl\u003d8fa427c6a3eaad7af2583c0a0ab9af404f41f140\u0026l\u003d23\n\nThis is slightly terrifying, but it seems to be existing practice - e.g. http://cs/android-internal/frameworks/native/cmds/dumpstate/DumpstateUtil.cpp?rcl\u003d81255c2b1e8cdd290c66aac31e5a932a23e29d62\u0026l\u003d273.\n\nPresumably you don\u0027t attempt this on a user build?\n\nAnd I guess you don\u0027t need this CL at all now?\n\nTBH I\u0027d prefer you to fix the permissions on wmtrace (the selinux protection is sufficient) and avoid using su.",
      "parentUuid": "2d161340_e5b6fb1e",
      "range": {
        "startLine": 28,
        "startChar": 1,
        "endLine": 28,
        "endChar": 62
      },
      "revId": "2ee1a914088bc9e8b334a2cb6292f6b63a80fda6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ca28cb49_ecb99914",
        "filename": "private/dumpstate.te",
        "patchSetId": 1
      },
      "lineNbr": 28,
      "author": {
        "id": 1954223
      },
      "writtenOn": "2022-09-23T11:58:54Z",
      "side": 1,
      "message": "\u003e Presumably you don\u0027t attempt this on a user build?\n\nCorrect. It is executed only in userdebug/eng builds\n\n\u003e And I guess you don\u0027t need this CL at all now?\n\nNo, if we decide to use `su`. Sorry about the noise. On the bright side, I learned one thing or two and the next time I\u0027ll bother you less ;)\n\n\u003e TBH I\u0027d prefer you to fix the permissions on wmtrace (the selinux protection is sufficient) and avoid using su.\n\nI totally agree that `chmod o+w /data/misc/wmtrace` is way better than executing stuff out of SELinux supervision with `su`. Nevertheless, I know that soon there will be a refactoring, `/system/bin/layertracegenerator` is going to disappear from the filesystem, the logic will be moved within the surfaceflinger service and dumpstate won\u0027t need to call exec(2) anymore. Considering that, I lean towards using `su` as a temporary solution that will be very simple to revert.",
      "parentUuid": "5ea521ad_6622afd5",
      "range": {
        "startLine": 28,
        "startChar": 1,
        "endLine": 28,
        "endChar": 62
      },
      "revId": "2ee1a914088bc9e8b334a2cb6292f6b63a80fda6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "05cdde50_05485b8f",
        "filename": "private/layertracegenerator.te",
        "patchSetId": 1
      },
      "lineNbr": 4,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2022-09-22T11:27:00Z",
      "side": 1,
      "message": "Nit: You can do this in one line as:\n\ntype layertracegenerator, domain, coredomain;",
      "range": {
        "startLine": 3,
        "startChar": 0,
        "endLine": 4,
        "endChar": 45
      },
      "revId": "2ee1a914088bc9e8b334a2cb6292f6b63a80fda6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "84a712e7_5dd7f081",
        "filename": "private/layertracegenerator.te",
        "patchSetId": 1
      },
      "lineNbr": 11,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2022-09-22T11:27:00Z",
      "side": 1,
      "message": "Do you need r, or would w_(file|dir)_perms be enough?",
      "range": {
        "startLine": 10,
        "startChar": 0,
        "endLine": 11,
        "endChar": 66
      },
      "revId": "2ee1a914088bc9e8b334a2cb6292f6b63a80fda6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}