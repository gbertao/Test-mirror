{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "f50dfc28_d74ec68d",
        "filename": "private/bpfloader.te",
        "patchSetId": 2
      },
      "lineNbr": 37,
      "author": {
        "id": 1054468
      },
      "writtenOn": "2023-08-30T18:28:13Z",
      "side": 1,
      "message": "this is the default label for bpf fs. Instead of granting uprobed access to the default label, you should instead create a new type (e.g. fs_bpf_uprobe) for files intended to be read by uprobed. That allows you to properly limit access to just the things that should have access. See for example, line 39 where only the network_stack (and bpfloader) are exempted from the restriction to access fs_bpf_net_private.\n\nYou can see how type type is declared here:\nhttps://cs.android.com/android/platform/superproject/main/+/main:system/sepolicy/private/file.te;l\u003d6?q\u003dfs_bpf_net_private\n\nAnd how it\u0027s mapped to a file path here:\nhttps://cs.android.com/android/platform/superproject/main/+/main:system/sepolicy/private/genfs_contexts;l\u003d407?q\u003dgenfs_context",
      "range": {
        "startLine": 37,
        "startChar": 133,
        "endLine": 37,
        "endChar": 139
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cb89d79e_147151c0",
        "filename": "private/bpfloader.te",
        "patchSetId": 2
      },
      "lineNbr": 37,
      "author": {
        "id": 1952023
      },
      "writtenOn": "2023-09-01T21:24:34Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "f50dfc28_d74ec68d",
      "range": {
        "startLine": 37,
        "startChar": 133,
        "endLine": 37,
        "endChar": 139
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b3a92c38_6f4e785b",
        "filename": "private/coredomain.te",
        "patchSetId": 2
      },
      "lineNbr": 155,
      "author": {
        "id": 1054468
      },
      "writtenOn": "2023-08-30T18:28:13Z",
      "side": 1,
      "message": "This is likewise a default. Similar to what you did for fs_bpf, you should provide a new type here and not use the default one.",
      "range": {
        "startLine": 155,
        "startChar": 4,
        "endLine": 155,
        "endChar": 9
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "6cfd1a0a_4f333fb6",
        "filename": "private/coredomain.te",
        "patchSetId": 2
      },
      "lineNbr": 155,
      "author": {
        "id": 1952023
      },
      "writtenOn": "2023-09-01T21:24:34Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b3a92c38_6f4e785b",
      "range": {
        "startLine": 155,
        "startChar": 4,
        "endLine": 155,
        "endChar": 9
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b70e409a_dcabf4f2",
        "filename": "private/uprobed.te",
        "patchSetId": 2
      },
      "lineNbr": 1,
      "author": {
        "id": 1952023
      },
      "writtenOn": "2023-09-01T21:24:34Z",
      "side": 1,
      "message": "FYI - renamed this to uprobestats.",
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "199eb500_df438c90",
        "filename": "private/uprobed.te",
        "patchSetId": 2
      },
      "lineNbr": 6,
      "author": {
        "id": 1054468
      },
      "writtenOn": "2023-08-30T18:28:13Z",
      "side": 1,
      "message": "It\u0027s not clear to me that you actually want this. It sounds like it\u0027s not the long-term plan.",
      "range": {
        "startLine": 6,
        "startChar": 0,
        "endLine": 6,
        "endChar": 47
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "280232f4_dd858bab",
        "filename": "private/uprobed.te",
        "patchSetId": 2
      },
      "lineNbr": 6,
      "author": {
        "id": 1952023
      },
      "writtenOn": "2023-09-01T21:24:34Z",
      "side": 1,
      "message": "Added a domain_auto_trans for statsd-\u003euprobe. This is what we are planning to use in production.\n\nFor development work though, I think we want to keep shell-\u003euprobe around in the long run. This would allow us to start the program using adb shell and troubleshoot it as we develop new features.",
      "parentUuid": "199eb500_df438c90",
      "range": {
        "startLine": 6,
        "startChar": 0,
        "endLine": 6,
        "endChar": 47
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cf78a181_c3d55200",
        "filename": "private/uprobed.te",
        "patchSetId": 2
      },
      "lineNbr": 11,
      "author": {
        "id": 1054468
      },
      "writtenOn": "2023-08-30T18:28:13Z",
      "side": 1,
      "message": "I\u0027m surprised that you need access to this? Why?",
      "range": {
        "startLine": 11,
        "startChar": 0,
        "endLine": 11,
        "endChar": 56
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d97d556b_204c8d06",
        "filename": "private/uprobed.te",
        "patchSetId": 2
      },
      "lineNbr": 11,
      "author": {
        "id": 1952023
      },
      "writtenOn": "2023-09-01T21:24:34Z",
      "side": 1,
      "message": "Removed kernel from the list.\n\n\"open\" is needed by perf_event_open, which is used to set up uprobe.\n\nFrom the manpage of perf_event_open:\n              kprobe and uprobe (since Linux 4.17)\n                     These two dynamic PMUs create a kprobe/uprobe and\n                     attach it to the file descriptor generated by\n                     perf_event_open.  The kprobe/uprobe will be\n                     destroyed on the destruction of the file\n                     descriptor.  See fields kprobe_func, uprobe_path,\n                     kprobe_addr, and probe_offset for more details.\n\n\nThe kernel code that checks for this permission is at https://source.corp.google.com/h/android/kernel/common/+/android-mainline:kernel/events/core.c;l\u003d12350?q\u003dPERF_EVENT_IOC_SET_BPF\u0026sq\u003drepo:android%2Fkernel%2Fcommon%20b:android-mainline\n\n\n\"cpu\" is needed by perf_event_open when uprobe is created without a specific pid. In the implementation of perf_event_open, task remains null if pid \u003d\u003d -1 [1], and then in find_get_context(), perf_allow_cpu() is called to check for the CPU permission [2].\n\n\n\"write\" is needed by ioctl(*pfd, PERF_EVENT_IOC_SET_BPF, progfd) [3], which is used to attach a BPF program to uprobe.\n\n\n[1] https://source.corp.google.com/h/android/kernel/common/+/android-mainline:kernel/events/core.c;l\u003d12414-12415?q\u003dPERF_EVENT_IOC_SET_BPF\u0026sq\u003drepo:android%2Fkernel%2Fcommon%20b:android-mainline\n[2] https://source.corp.google.com/h/android/kernel/common/+/android-mainline:kernel/events/core.c;l\u003d4742?q\u003dPERF_EVENT_IOC_SET_BPF\u0026sq\u003drepo:android%2Fkernel%2Fcommon%20b:android-mainline\n[3] https://source.corp.google.com/h/googleplex-android/platform/superproject/main/+/main:external/bcc/src/cc/libbpf.c;l\u003d1085?q\u003dexternal%2Fbcc%2Fsrc%2Fcc%2Flibbpf.c\u0026sq\u003drepo:googleplex-android%2Fplatform%2Fsuperproject%2Fmain%20b:main",
      "parentUuid": "cf78a181_c3d55200",
      "range": {
        "startLine": 11,
        "startChar": 0,
        "endLine": 11,
        "endChar": 56
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1f74714d_ad06982f",
        "filename": "private/uprobed.te",
        "patchSetId": 2
      },
      "lineNbr": 16,
      "author": {
        "id": 1054468
      },
      "writtenOn": "2023-08-30T18:28:13Z",
      "side": 1,
      "message": "why?",
      "range": {
        "startLine": 16,
        "startChar": 14,
        "endLine": 16,
        "endChar": 20
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b9cba824_d90e18b4",
        "filename": "private/uprobed.te",
        "patchSetId": 2
      },
      "lineNbr": 16,
      "author": {
        "id": 1952023
      },
      "writtenOn": "2023-09-01T21:24:34Z",
      "side": 1,
      "message": "This is to allow stdout access when executed via adb shell for development purpose.",
      "parentUuid": "1f74714d_ad06982f",
      "range": {
        "startLine": 16,
        "startChar": 14,
        "endLine": 16,
        "endChar": 20
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "67b12f69_13546382",
        "filename": "private/uprobed.te",
        "patchSetId": 2
      },
      "lineNbr": 17,
      "author": {
        "id": 1054468
      },
      "writtenOn": "2023-08-30T18:28:13Z",
      "side": 1,
      "message": "is this necessary?",
      "range": {
        "startLine": 17,
        "startChar": 35,
        "endLine": 17,
        "endChar": 39
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0a43c35c_37c30e50",
        "filename": "private/uprobed.te",
        "patchSetId": 2
      },
      "lineNbr": 17,
      "author": {
        "id": 1952023
      },
      "writtenOn": "2023-09-01T21:24:34Z",
      "side": 1,
      "message": "Removed.",
      "parentUuid": "67b12f69_13546382",
      "range": {
        "startLine": 17,
        "startChar": 35,
        "endLine": 17,
        "endChar": 39
      },
      "revId": "bf707f8e5aa625ae6b5b46c0ec666b94e9ee6971",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}