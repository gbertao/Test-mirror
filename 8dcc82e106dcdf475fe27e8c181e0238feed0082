{
  "comments": [
    {
      "key": {
        "uuid": "5c3ead4f_b4c91022",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1208973
      },
      "writtenOn": "2020-09-16T17:51:22Z",
      "side": 1,
      "message": "What exactly is /dev/dma_heap/system?\n\nAlso, the denials you posted are only for platform_app.  Do all apps need it, or just platform apps?",
      "revId": "8dcc82e106dcdf475fe27e8c181e0238feed0082",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "26565ed7_38783fd9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1010110
      },
      "writtenOn": "2020-09-16T18:36:37Z",
      "side": 1,
      "message": "\"/dev/dma_heap/system\" is the devnode for the system dmabuf heap. This is the future replacement for ion, only we have per-heap devnodes (which makes it easier to restrict permissions on a per-heap basis). \n\nAs for the platform_app bit, I\u0027ll defer to Hridya for a precise answer (I\u0027m not super familiar with all the sepolicy types).  But the motivating factor here is trying to allow the codec2 code to use dmabuf heaps when ION is not present. Normally gralloc would be the main user, but codec2 has its own allocation system.  \n\nSo this would likely map very closely to the usage and permissions on /dev/ion.",
      "parentUuid": "5c3ead4f_b4c91022",
      "revId": "8dcc82e106dcdf475fe27e8c181e0238feed0082",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "36e1d95c_9f1f6525",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1208973
      },
      "writtenOn": "2020-09-16T18:51:35Z",
      "side": 1,
      "message": "Ah, thanks, that\u0027s really helpful!\n\nIt looks like the existing rules for ion_device are read-only for appdomain and system_server.  I assume something has changed since ion_device that makes the writes required?",
      "parentUuid": "26565ed7_38783fd9",
      "revId": "8dcc82e106dcdf475fe27e8c181e0238feed0082",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "467c2d0e_2d0dd8af",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1120612
      },
      "writtenOn": "2020-09-16T19:51:12Z",
      "side": 1,
      "message": "Hi Joel and John, thank you for taking a look! ION was not part of NDK due to the unstable nature of its ABI. Hence, I don\u0027 think we had any other app users for it. I will dig around to understand why the write access is needed and get back to you shortly.",
      "parentUuid": "36e1d95c_9f1f6525",
      "revId": "8dcc82e106dcdf475fe27e8c181e0238feed0082",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "27ff3ecb_7e7c5790",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1120612
      },
      "writtenOn": "2020-09-16T20:17:46Z",
      "side": 1,
      "message": "Looks like the write permission denials were due to the userspace library(libdmabufheap) trying to open the heap device as RW. Once I corrected this, the write denials went away. I will fix the library and upload a new patch set here. Thanks for catching that Joel!",
      "parentUuid": "467c2d0e_2d0dd8af",
      "revId": "8dcc82e106dcdf475fe27e8c181e0238feed0082",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4cb7774d_cbe66ab5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1054468
      },
      "writtenOn": "2020-09-16T20:21:15Z",
      "side": 1,
      "message": "Are we adding another same-process HAL?",
      "revId": "8dcc82e106dcdf475fe27e8c181e0238feed0082",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "50d0b91a_e1f6d128",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1010110
      },
      "writtenOn": "2020-09-16T20:26:36Z",
      "side": 1,
      "message": "I believe it has to do with dma-buf heaps having a more pedantic view of reading vs writing on an ioctl compared with ion.\n\nSince the ioctl has to provide the size and flags for the allocation, its effectively writing those values to the kernel, and then reads back the fd of the buffer returned.",
      "parentUuid": "467c2d0e_2d0dd8af",
      "revId": "8dcc82e106dcdf475fe27e8c181e0238feed0082",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d02a3923_ab7db56c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1054468
      },
      "writtenOn": "2020-09-16T20:33:33Z",
      "side": 1,
      "message": "I guess the question really is: how is this not a Treble violation?",
      "parentUuid": "4cb7774d_cbe66ab5",
      "revId": "8dcc82e106dcdf475fe27e8c181e0238feed0082",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "d07231e3_f2b6f630",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1120612
      },
      "writtenOn": "2020-09-16T20:49:59Z",
      "side": 1,
      "message": "Hi Jeff, \n\nThe DMA-BUF heap framework is a replacement for ION. It is not a Treble violation to use it from framework code since DMA-BUF heaps are guaranteed to be ABI stable because they are part of upstream linux. Moreover, the DMA-BUF system heap will be built into the GKI 2.0 kernel. This patch is to enable codec2(which is currently the only framework ION user) to make the switch to DMA-BUF heaps.\n\nPlease let me know if you have more questions!\n\nThanks,\nHridya",
      "parentUuid": "d02a3923_ab7db56c",
      "revId": "8dcc82e106dcdf475fe27e8c181e0238feed0082",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "00b0cb36_08b4acd5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1120612
      },
      "writtenOn": "2020-09-17T21:47:55Z",
      "side": 1,
      "message": "We realized that r_file_perms includes the permissions for doing this and everything seems to work! I have uploaded a new PS fixing this.",
      "parentUuid": "50d0b91a_e1f6d128",
      "revId": "8dcc82e106dcdf475fe27e8c181e0238feed0082",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}