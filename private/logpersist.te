# android user-space log printing covering logpersist domains (userdebug only)
userdebug_or_eng(`

type logpersist, domain, mlstrustedsubject;

domain_auto_trans(init, logcat_exec, logpersist)

r_dir_file(logpersist, cgroup)

allow logpersist misc_logd_file:file create_file_perms;
allow logpersist misc_logd_file:dir rw_dir_perms;

allow logpersist self:capability sys_nice;
allow logpersist pstorefs:dir search;
allow logpersist pstorefs:file r_file_perms;

control_logd(logpersist)

unix_socket_connect(logpersist, logdr, logd)

###
### Neverallow rules
###
### logpersist should NEVER do any of this

# Block device access.
neverallow logpersist dev_type:blk_file { read write };

# ptrace any other app
neverallow logpersist domain:process ptrace;

# Write to /system.
neverallow logpersist system_file:dir_file_class_set write;

# Write to files in /data/data or system files on /data
neverallow logpersist { app_data_file system_data_file }:dir_file_class_set write;

# logpersist is allowed to write to /data/misc/logd
neverallow logpersist { file_type -misc_logd_file -coredump_file }:file { create write append };

')

# logpersist is only allowed on userdebug/eng builds for misc_logd_file
neverallow { domain userdebug_or_eng(`-logpersist') -dumpstate } misc_logd_file:file no_rw_file_perms;
neverallow { domain userdebug_or_eng(`-logpersist') } misc_logd_file:dir { add_name link relabelfrom remove_name rename reparent rmdir write };
neverallow { domain -init } misc_logd_file:dir create;
