{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "516133e6_ec7d0f23",
        "filename": "private/apexd.te",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2021-01-28T17:45:32Z",
      "side": 1,
      "message": "If both .../compresed and .../active are staging_data_file, why apex_data_file here?",
      "range": {
        "startLine": 9,
        "startChar": 12,
        "endLine": 9,
        "endChar": 31
      },
      "revId": "c97a7c0f37af5ce2f98b92ffb640b597e056b952",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dce94d35_bab93b0b",
        "filename": "private/apexd.te",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1439319
      },
      "writtenOn": "2021-01-28T18:09:59Z",
      "side": 1,
      "message": "This is the labeling:\n\n```\n/data/apex(/.*)?\t\tu:object_r:apex_data_file:s0\n/data/apex/active/(.*)?\t\tu:object_r:staging_data_file:s0\n/data/apex/decompressed/(.*)?    u:object_r:staging_data_file:s0\n```\n\nWe have already given apexd permission to link staging_data_file in line-82 \n\n```allow apexd staging_data_file:file { r_file_perms link };```\n\nYet, it\u0027s not enough. We get the following denial:\n\n`apexd   : type\u003d1400 audit(0.0:15): avc: denied { link } for name\u003d\"com.android.apex.compressed@1.apex\" dev\u003d\"dm-9\" ino\u003d4109 scontext\u003du:r:apexd:s0 tcontext\u003du:object_r:apex_data_file:s0 tclass\u003dfile permissive\u003d0`\n\nBased on this, I realized, apexd doesn\u0027t have permission under the parent folder (/data/apex/*). At line-174 we have \n`neverallow { domain -apexd } apex_info_file:file no_w_file_perms;`\nthat prevents linking under apex_data_file. This line counters that restriction.\n\nWith this line here, I don\u0027t get any selinux denial.",
      "parentUuid": "516133e6_ec7d0f23",
      "range": {
        "startLine": 9,
        "startChar": 12,
        "endLine": 9,
        "endChar": 31
      },
      "revId": "c97a7c0f37af5ce2f98b92ffb640b597e056b952",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f5cbbff3_32398398",
        "filename": "private/apexd.te",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2021-01-28T18:15:22Z",
      "side": 1,
      "message": "\u003e This is the labeling:\n\u003e \n\u003e ```\n\u003e /data/apex(/.*)?\t\tu:object_r:apex_data_file:s0\n\u003e /data/apex/active/(.*)?\t\tu:object_r:staging_data_file:s0\n\u003e /data/apex/decompressed/(.*)?    u:object_r:staging_data_file:s0\n\u003e ```\n\u003e \n\u003e We have already given apexd permission to link staging_data_file in line-82 \n\u003e \n\u003e ```allow apexd staging_data_file:file { r_file_perms link };```\n\u003e \n\u003e Yet, it\u0027s not enough. We get the following denial:\n\u003e \n\u003e `apexd   : type\u003d1400 audit(0.0:15): avc: denied { link } for name\u003d\"com.android.apex.compressed@1.apex\" dev\u003d\"dm-9\" ino\u003d4109 scontext\u003du:r:apexd:s0 tcontext\u003du:object_r:apex_data_file:s0 tclass\u003dfile permissive\u003d0`\n\nWhich directory is that file in? You should be able to figure it out from the inode #, if you don\u0027t get the full path.\n\n(I\u0027ve no objection to granting the permission, but I\u0027d like the comment to be correct.)\n\n\u003e \n\u003e Based on this, I realized, apexd doesn\u0027t have permission under the parent folder (/data/apex/*). At line-174 we have \n\u003e `neverallow { domain -apexd } apex_info_file:file no_w_file_perms;`\n\u003e that prevents linking under apex_data_file. This line counters that restriction.\n\nStrictly that\u0027s irrelevant, since apexd is exempted from the neverallow. But yeah, you only get what\u0027s explicitly allowed.\n\n\u003e \n\u003e With this line here, I don\u0027t get any selinux denial.",
      "parentUuid": "dce94d35_bab93b0b",
      "range": {
        "startLine": 9,
        "startChar": 12,
        "endLine": 9,
        "endChar": 31
      },
      "revId": "c97a7c0f37af5ce2f98b92ffb640b597e056b952",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8e45a083_e7f455e2",
        "filename": "private/apexd.te",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1432579
      },
      "writtenOn": "2021-01-28T18:19:05Z",
      "side": 1,
      "message": "Discussed with Samiul offline. For some reason, when apexd decompresses into /data/apex/decompressed/, a wrong selinux label (apex_data_file instead of staging_data_file) is applied. We are investigating further.",
      "parentUuid": "f5cbbff3_32398398",
      "range": {
        "startLine": 9,
        "startChar": 12,
        "endLine": 9,
        "endChar": 31
      },
      "revId": "c97a7c0f37af5ce2f98b92ffb640b597e056b952",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "20bfc1c5_eb56bf1f",
        "filename": "private/apexd.te",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1439319
      },
      "writtenOn": "2021-01-29T10:55:55Z",
      "side": 1,
      "message": "When we create a file inside a directory with label X, it gets label X. Had to run restorecon in the end to fix the labeling. So now we need to give apexd relabeling permissions. Please see the new patch.",
      "parentUuid": "8e45a083_e7f455e2",
      "range": {
        "startLine": 9,
        "startChar": 12,
        "endLine": 9,
        "endChar": 31
      },
      "revId": "c97a7c0f37af5ce2f98b92ffb640b597e056b952",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}