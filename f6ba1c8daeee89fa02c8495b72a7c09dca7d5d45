{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "b3c82f57_5ebd07c8",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2023-07-30T12:20:06Z",
      "side": 1,
      "message": "Could you add a link to the corresponding code in vold where this is done?",
      "range": {
        "startLine": 9,
        "startChar": 24,
        "endLine": 9,
        "endChar": 70
      },
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "adc92a6d_adfcfc49",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2023-07-31T17:19:30Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b3c82f57_5ebd07c8",
      "range": {
        "startLine": 9,
        "startChar": 24,
        "endLine": 9,
        "endChar": 70
      },
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b9560db7_acbe7180",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2023-07-31T18:53:51Z",
      "side": 1,
      "message": "This still doesn\u0027t show the exact code being used or show why we are making this change. Why is this required for 16K? How does wiping now (is it only in fastboot)?",
      "parentUuid": "adc92a6d_adfcfc49",
      "range": {
        "startLine": 9,
        "startChar": 24,
        "endLine": 9,
        "endChar": 70
      },
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b39aca4b_4bfab94f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2023-07-31T20:25:57Z",
      "side": 1,
      "message": "There\u0027s too many code links, they would not fit in a commit message. So let me explain here\n\n1. init calls encryptFstab with should_format set to true\n\nhttps://source.corp.google.com/h/googleplex-android/platform/superproject/main/+/main:system/core/fs_mgr/fs_mgr.cpp;l\u003d1543;drc\u003d9a85b15ae280cc30c729f62926afce2d810967a4;bpv\u003d1;bpt\u003d1?q\u003dfs_mgr.cpp\u0026sq\u003drepo:googleplex-android%2Fplatform%2Fsuperproject%2Fmain%09branch:main\n\n\n2. encryptFstab might call mkfs.ext4 to format a volume, code \n\nhttps://source.corp.google.com/h/googleplex-android/platform/superproject/main/+/refs/heads/main:system/vold/fs/Ext4.cpp;drc\u003d9a85b15ae280cc30c729f62926afce2d810967a4;l\u003d159\n\n3. Later, mkfs.ext4  uses BLKDISCARDZEROES to wipe a block device.\n\nhttps://source.corp.google.com/h/googleplex-android/platform/superproject/main/+/refs/heads/main:external/e2fsprogs/lib/ext2fs/unix_io.c;l\u003d796;drc\u003d9a85b15ae280cc30c729f62926afce2d810967a4;bpv\u003d1;bpt\u003d1\n\nThis code path is only invoked if the /data partition does not already contain a valid file system. Today\u0027s devices usually boot with a valid /data partition so this code path is not exercised. If we ask cuttlefish to create a new data image(`-data_policy\u003dalways_create` ), this code path will be executed",
      "parentUuid": "b9560db7_acbe7180",
      "range": {
        "startLine": 9,
        "startChar": 24,
        "endLine": 9,
        "endChar": 70
      },
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7ab6d17f_60d2af2c",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2023-08-01T02:24:10Z",
      "side": 1,
      "message": "Thanks for the detailed explanation, Kelvin. I have a few follow-up questions though. According to your explanation, vold seems to be formatting the partition indirectly via the `mke2fs` program. Is that right?\n\n`mke2fs` is labeled [1] as `e2fs_exec`, and we already have many allow rules for the domain `e2fs` [2]. The domain seems to already have enough privileges.\n\nHowever, what\u0027s missing is an automatic domain transition rule from `vold` to `mke2fs`. Since there\u0027s no such rule, `vold` executes `mke2fs` in its own domain `vold` which currently doesn\u0027t have the permissions to format a partition.\n\nSo, I think what\u0027s actually needed is something like\n\n`domain_auto_trans(vold, e2fs_exec, e2fs)`\n\nin `vold.te`. With this we may be able to even remove some of the permissions from vold which were needed to execute code in e2fs.\n\nWhat do you think?\n\n[1] https://cs.android.com/android/platform/superproject/main/+/main:system/sepolicy/private/file_contexts;drc\u003d486fa9fb0a53f9ce6edb04295f4bec8b0acca0cb;l\u003d230\n\n[2] https://cs.android.com/android/platform/superproject/main/+/main:system/sepolicy/public/e2fs.te",
      "parentUuid": "b39aca4b_4bfab94f",
      "range": {
        "startLine": 9,
        "startChar": 24,
        "endLine": 9,
        "endChar": 70
      },
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4e49c934_6ce98f74",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2023-08-01T19:41:35Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "7ab6d17f_60d2af2c",
      "range": {
        "startLine": 9,
        "startChar": 24,
        "endLine": 9,
        "endChar": 70
      },
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3fabd99a_7756533b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2023-07-28T01:13:50Z",
      "side": 1,
      "message": "I\u0027m not very familiar with these permissions. Jeff/Jiyong, do you have expertise or know who does? I can also do some research if not.",
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "96c11454_8f411101",
        "filename": "public/vold.te",
        "patchSetId": 1
      },
      "lineNbr": 162,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2023-07-28T01:13:50Z",
      "side": 1,
      "message": "you can delete this (add everything to the same list)",
      "range": {
        "startLine": 160,
        "startChar": 95,
        "endLine": 162,
        "endChar": 42
      },
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1c832af4_db43e16f",
        "filename": "public/vold.te",
        "patchSetId": 1
      },
      "lineNbr": 162,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2023-07-28T17:44:49Z",
      "side": 1,
      "message": "This puts permission into functional groups with a documentation on what is added and why these permissions are added. I think this provides are more readable historical records. WDYT?",
      "parentUuid": "96c11454_8f411101",
      "range": {
        "startLine": 160,
        "startChar": 95,
        "endLine": 162,
        "endChar": 42
      },
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "594266bb_36d148f4",
        "filename": "public/vold.te",
        "patchSetId": 1
      },
      "lineNbr": 162,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2023-07-28T17:57:33Z",
      "side": 1,
      "message": "I actually would in general recommend avoiding comments here, because they can become inaccurate. This is what is used for now, but if the vold implementation changes, then the comment is out of date. We don\u0027t want people reading comments and think they understand things, we want them to read the actual policy and think about that and what possible implementations or bugs it could allow.\n\nnnk/jeffv/danielcashmen used to delete a lot of the comments.\n\nStill, you can put the group on multiple lines and still make comments, e.g.:\n\n```\nallowxperm vold dm_device:blk_file ioctl {\n    BLKDISCARD\n    BLKSECDISCARD\n    BLKREPORTZONE\n    BLKRESETZONE \n\n    # needed for formatting a block device, vold might format /data partition\n    BLKGETSIZE64\n    BLKPBSZGET\n    BLKDISCARDZEROES\n    BLKROGET\n    BLKROSET\n};\n```\n\nI\u0027m still waiting on the other reviewers, but I think this should be preferred because it is faster to understand these permissions are related.",
      "parentUuid": "1c832af4_db43e16f",
      "range": {
        "startLine": 160,
        "startChar": 95,
        "endLine": 162,
        "endChar": 42
      },
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "359abec3_363cb50f",
        "filename": "public/vold.te",
        "patchSetId": 1
      },
      "lineNbr": 162,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2023-07-30T12:20:06Z",
      "side": 1,
      "message": "Yeah, the style Steven suggested looks better to me.",
      "parentUuid": "594266bb_36d148f4",
      "range": {
        "startLine": 160,
        "startChar": 95,
        "endLine": 162,
        "endChar": 42
      },
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "40c70523_30fa42b5",
        "filename": "public/vold.te",
        "patchSetId": 1
      },
      "lineNbr": 162,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2023-07-31T17:19:30Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "359abec3_363cb50f",
      "range": {
        "startLine": 160,
        "startChar": 95,
        "endLine": 162,
        "endChar": 42
      },
      "revId": "f6ba1c8daeee89fa02c8495b72a7c09dca7d5d45",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}