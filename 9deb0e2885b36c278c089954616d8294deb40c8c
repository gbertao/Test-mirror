{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "d21c3388_67fe8e5d",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 40,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2022-06-07T14:53:55Z",
      "side": 1,
      "message": "Nit: What permissions do you actually need for lnk_file?\ninstalld only has getattr. Not that it makes a huge difference, AIUI.\nhttp://cs/android-internal/system/sepolicy/prebuilts/api/30.0/public/installd.te?rcl\u003d5131ff65443d3cc17bf03c239f6fdb28432ba3c7\u0026l\u003d92",
      "range": {
        "startLine": 40,
        "startChar": 40,
        "endLine": 40,
        "endChar": 48
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2cac05c2_e17dfb61",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 40,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2022-06-07T16:23:48Z",
      "side": 1,
      "message": "Thanks for pointing this out. For lnk_file, what we need is to follow symlinks because I have a vague impression that vdex files can be shared among multiple ISAs through symlinks in some cases. I guess getattr should be sufficient.",
      "parentUuid": "d21c3388_67fe8e5d",
      "range": {
        "startLine": 40,
        "startChar": 40,
        "endLine": 40,
        "endChar": 48
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bfea6eaa_0897e606",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 40,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2022-06-07T16:39:45Z",
      "side": 1,
      "message": "You need read in order to follow the link, and getattr if you want to be able to stat (or possibly lstat) it. I\u0027d grant both. That\u0027s pretty common.",
      "parentUuid": "2cac05c2_e17dfb61",
      "range": {
        "startLine": 40,
        "startChar": 40,
        "endLine": 40,
        "endChar": 48
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4b3811b2_957fa907",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 40,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2022-06-07T20:13:12Z",
      "side": 1,
      "message": "OK, if installd doesn\u0027t have read, we don\u0027t need it either. I just realized that these are rules for artifacts generated **on device**. We don\u0027t use symlinks for those.",
      "parentUuid": "bfea6eaa_0897e606",
      "range": {
        "startLine": 40,
        "startChar": 40,
        "endLine": 40,
        "endChar": 48
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "58d26382_9e380ba3",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 51,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2022-06-07T14:53:55Z",
      "side": 1,
      "message": "Are you able to give a brief description of why you need each of these, mostly for the benefit of future readers?\ndac_override dac_read_search is for accessing files in app data directories, ignoring DAC permissions.\nsetgid setuid is for impersonating apps? Why? (And if you have that, why do you need dac_override?)\nchown, fowner - ?",
      "range": {
        "startLine": 51,
        "startChar": 0,
        "endLine": 51,
        "endChar": 62
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "413d44b6_84b8d3aa",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 51,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2022-06-07T16:23:48Z",
      "side": 1,
      "message": "Added some comments.\n\nAlso rethought about this and dropped some capabilities:\n- \"chown\": We need to transfer the ownership of the files to apps after creating them, but we probably don\u0027t need root capabilities to do that.\n- \"setgid\", \"setuid\": I saw installd doing this before execing ART binaries. The reason for doing this is to drop root permissions. I guess we don\u0027t need this because artd does not run as the root UID in the first place. We just need to drop capabilities by calling capset. Am I understanding it correctly?",
      "parentUuid": "58d26382_9e380ba3",
      "range": {
        "startLine": 51,
        "startChar": 0,
        "endLine": 51,
        "endChar": 62
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "42b9a57b_502118fe",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 51,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2022-06-07T16:39:45Z",
      "side": 1,
      "message": "I\u0027m unsure about this.\nYou change selinux context as well when you run those binaries, don\u0027t you? In which case they won\u0027t have access to the capabilities anyway.\n\n(Maybe we should add \"neverallow artd { file_type fs_type }:file execute_no_trans;\", as we do with init, just to make sure we don\u0027t accidentally pass on these capabilities.)",
      "parentUuid": "413d44b6_84b8d3aa",
      "range": {
        "startLine": 51,
        "startChar": 0,
        "endLine": 51,
        "endChar": 62
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f51c6629_b45dae5f",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 51,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2022-06-07T17:28:34Z",
      "side": 1,
      "message": "Calin, sorry for one more question. Does installd switches selinux context?\n\nI don\u0027t see the code doing that. http://cs/android-internal/frameworks/native/cmds/installd/dexopt.cpp;l\u003d1968;rcl\u003d74edc7584d00a7f07c04356995761e44329d858e",
      "parentUuid": "42b9a57b_502118fe",
      "range": {
        "startLine": 51,
        "startChar": 0,
        "endLine": 51,
        "endChar": 62
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5f491505_dc33a173",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 51,
      "author": {
        "id": 1022077
      },
      "writtenOn": "2022-06-07T19:29:32Z",
      "side": 1,
      "message": "We don\u0027t explicitly change the context but we do drop capabilities as here: https://source.corp.google.com/android-internal/frameworks/native/cmds/installd/utils.cpp;rcl\u003d8b645f865a03de3a9d56f3507ccbc45be22efe36;l\u003d1402#:~:text\u003d1401-,1402,-1403\n\nI don\u0027t know the underlying implementation and whether or not behind the scenes there\u0027s a context change.",
      "parentUuid": "f51c6629_b45dae5f",
      "range": {
        "startLine": 51,
        "startChar": 0,
        "endLine": 51,
        "endChar": 62
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "6e00d513_d81f6657",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 51,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2022-06-07T20:13:12Z",
      "side": 1,
      "message": "Thanks, Calin.\n\nMaybe installd doesn\u0027t change selinux context today, but I think it\u0027s a good idea to change selinux context in artd. I\u0027ll add the neverallow rule when we add rules for executing ART binaries. Thanks for the discussion.",
      "parentUuid": "5f491505_dc33a173",
      "range": {
        "startLine": 51,
        "startChar": 0,
        "endLine": 51,
        "endChar": 62
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4408431d_ba699b12",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 51,
      "author": {
        "id": 1054468
      },
      "writtenOn": "2022-06-08T07:10:41Z",
      "side": 1,
      "message": "Calin! o/",
      "parentUuid": "6e00d513_d81f6657",
      "range": {
        "startLine": 51,
        "startChar": 0,
        "endLine": 51,
        "endChar": 62
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d64cb275_6ce6931b",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 51,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2022-06-08T08:50:50Z",
      "side": 1,
      "message": "The selinux context switch on execution happens automatically, as a result of domain_auto_trans rules: http://cs/android-internal/system/sepolicy/private/installd.te?rcl\u003dd2ffd35cc04061dc49159d5ef31198f22dfb9bc5\u0026l\u003d10",
      "parentUuid": "4408431d_ba699b12",
      "range": {
        "startLine": 51,
        "startChar": 0,
        "endLine": 51,
        "endChar": 62
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "236a0b7a_1e855c99",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 51,
      "author": {
        "id": 1884045
      },
      "writtenOn": "2022-06-08T10:17:24Z",
      "side": 1,
      "message": "Ah, OK! Thanks for finding this out. Once we have domain_auto_trans rules, do we still need to call capset to drop root capabilities before exec? I.e., does exec automatically reset root capabilities when there are domain_auto_trans rules?",
      "parentUuid": "d64cb275_6ce6931b",
      "range": {
        "startLine": 51,
        "startChar": 0,
        "endLine": 51,
        "endChar": 62
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3c3937a1_aab87c5b",
        "filename": "private/artd.te",
        "patchSetId": 1
      },
      "lineNbr": 51,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2022-06-08T12:56:04Z",
      "side": 1,
      "message": "What an interesting question!\nI don\u0027t know, but I strongly suspect it does, otherwise this would be a trivial bypass to allow a process to use capabilities that the sepolicy restricts from it - in the same way that open file handles are replaced with handles to /dev/null if the new process\u0027s label is not allowed access.",
      "parentUuid": "236a0b7a_1e855c99",
      "range": {
        "startLine": 51,
        "startChar": 0,
        "endLine": 51,
        "endChar": 62
      },
      "revId": "9deb0e2885b36c278c089954616d8294deb40c8c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}